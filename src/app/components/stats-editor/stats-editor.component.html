<div class="container" *ngIf="character && statsForm">
  <h1 class="section-title">Investigator Statistics</h1>
  
  <form [formGroup]="statsForm">
    <mat-card>
      <mat-card-content>
        <h2>Basic Information</h2>
        
        <div class="form-row">
          <mat-form-field class="form-field-full-width">
            <mat-label>Character Name</mat-label>
            <input matInput formControlName="name" placeholder="Enter investigator name">
            <mat-error *ngIf="statsForm.get('name')?.hasError('required')">
              Name is required
            </mat-error>
          </mat-form-field>
        </div>
        
        <div class="form-row">
          <mat-form-field class="form-field-full-width">
            <mat-label>Age Range (Apply Effects)</mat-label>
            <select matNativeControl (change)="onAgeRangeChange($event)">
              <option value="">Select age range</option>
              <option *ngFor="let range of ageRanges" [value]="range.id" [selected]="range.id === selectedAgeRange?.id">
                {{ range.selectorName }}
              </option>
            </select>
          </mat-form-field>

          <mat-form-field class="form-field-full-width">
            <mat-label>Age</mat-label>
            <input matInput formControlName="age" type="number" [min]="selectedAgeRange?.min || 15" [max]="selectedAgeRange?.max || 89">
            <mat-error *ngIf="statsForm.get('age')?.hasError('required')">
              Age is required
            </mat-error>
            <mat-error *ngIf="statsForm.get('age')?.hasError('min') || statsForm.get('age')?.hasError('max')">
              Age must be between 15 and 89
            </mat-error>
          </mat-form-field>
        </div>
      </mat-card-content>
    </mat-card>
    
    <!-- Age Deduction Selection -->
    <app-age-effects-card [character]="character" [ageRange]="selectedAgeRange" (ageDeductionChange)="onAgeDeductionChange($event)"></app-age-effects-card>
    
    <mat-card>
      <mat-card-content>
        <div class="space-between">
          <h2>Characteristics</h2>
          <button mat-raised-button color="primary" (click)="rollAllStats()" 
                  matTooltip="Roll for all characteristics at once (using appropriate dice for each stat)">
            <mat-icon>casino</mat-icon> Roll All Stats
          </button>
        </div>
        
        <div class="stat-grid">
          <!-- STR -->
          <app-stat-card [character]="character" stat="str" name="STR (Strength)" desc="Physical power and muscle" (statRolled)="onStatRoll($event)"></app-stat-card>
          
          <!-- CON -->
          <app-stat-card [character]="character" stat="con" name="CON (Constitution)" desc="Health and resilience" (statRolled)="onStatRoll($event)"></app-stat-card>
          
          <!-- SIZ -->
          <app-stat-card [character]="character" stat="siz" name="SIZ (Size)" desc="Physical mass and stature" (statRolled)="onStatRoll($event)"></app-stat-card>
          
          <!-- DEX -->
          <app-stat-card [character]="character" stat="dex" name="DEX (Dexterity)" desc="Agility and reflexes" (statRolled)="onStatRoll($event)"></app-stat-card>
          
          <!-- APP -->
          <app-stat-card [character]="character" stat="app" name="APP (Appearance)" desc="Charisma and looks" (statRolled)="onStatRoll($event)"></app-stat-card>
          
          <!-- INT -->
          <app-stat-card [character]="character" stat="int" name="INT (Intelligence)" desc="Problem-solving and learning" (statRolled)="onStatRoll($event)"></app-stat-card>
          
          <!-- POW -->
          <app-stat-card [character]="character" stat="pow" name="POW (Power)" desc="Willpower and spirit" (statRolled)="onStatRoll($event)"></app-stat-card>
          
          <!-- EDU -->
          <app-stat-card [character]="character" stat="edu" name="EDU (Education)" desc="Learning and knowledge" (statRolled)="onStatRoll($event)"></app-stat-card>
          
          <!-- LUCK -->
          <app-stat-card [character]="character" stat="luck" name="Luck" desc="Fate and fortune" (statRolled)="onStatRoll($event)"></app-stat-card>
        </div>
      </mat-card-content>
    </mat-card>
    
    <!-- Derived Attributes -->
    <mat-card>
      <mat-card-content>
        <h2>Derived Attributes</h2>
        
        <div class="derived-grid">
          <div class="derived-item">
            <h3>Hit Points</h3>
            <div class="derived-value">{{ derivedHP }}</div>
            <p class="stat-desc">(CON + SIZ) / 10, rounded down</p>
          </div>
          
          <div class="derived-item">
            <h3>Damage Bonus</h3>
            <div class="derived-value">{{ derivedDamageBonus }}</div>
            <p class="stat-desc">Based on STR + SIZ</p>
          </div>
          
          <div class="derived-item">
            <h3>Build</h3>
            <div class="derived-value">{{ derivedBuild }}</div>
            <p class="stat-desc">Based on STR + SIZ</p>
          </div>
          
          <div class="derived-item">
            <h3>Movement Rate</h3>
            <div class="derived-value">{{ derivedMovementRate }}</div>
            <p class="stat-desc">Based on STR, DEX, SIZ, and age</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
    
    <div class="actions-container">
      <button mat-raised-button color="primary" (click)="saveAndContinue()" [disabled]="statsForm.invalid">
        Save and Continue
      </button>
    </div>
  </form>
</div>